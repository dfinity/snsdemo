#!/usr/bin/env bash

set -euo pipefail

SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

print_help() {
  cat <<-EOF

	Creates a dummy internet identity with a registered backup device and seed 
  phrase. This makes it easy to sign in with the fewer number of clicks.
	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
clap.define short=i long=identity desc="The dfx identity to use" variable=DFX_IDENTITY default="$(dfx identity whoami)"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

IDENTITY_PUB_KEY_FILE="$(mktemp)"

clean_up() {
  rm "$IDENTITY_PUB_KEY_FILE"
}

trap clean_up EXIT

DECLARATIONS_DIR="$(realpath "$SOURCE_DIR/../declarations")"
II_DID_FILE="$DECLARATIONS_DIR/internet_identity.did"

dfx identity export "$DFX_IDENTITY" | openssl ec -out "$IDENTITY_PUB_KEY_FILE" -pubout -outform der 2> /dev/null

#curl -SLs 'https://github.com/dfinity/internet-identity/releases/latest/download/internet_identity.did' -o "$II_DID_FILE"

echo "Fetching captcha."
CHALLENGE_KEY="$(dfx canister call internet_identity create_challenge --candid "$II_DID_FILE" --network "$DFX_NETWORK"| idl2json | jq -r .challenge_key)"

PUB_KEY_BLOB=$(hexdump -ve '1/1 "%.2x"' "$IDENTITY_PUB_KEY_FILE" | sed 's/../\\&/g')

echo "Creating anchor."
ANCHOR="$(dfx canister call internet_identity register "(record{pubkey=blob \"${PUB_KEY_BLOB}\";alias=\"dfx test key\";purpose=variant{authentication};key_type=variant{unknown};protection=variant{unprotected};},record{key=\"${CHALLENGE_KEY}\";chars=\"a\"})" --candid "$II_DID_FILE" --network "$DFX_NETWORK" | idl2json | jq -r .registered.user_number)"

II_CANISTER_ID="$(dfx canister id internet_identity --network "$DFX_NETWORK")"

DUMMY_PUB_KEY_BLOB='0*0\05\06\03+ep\03!\00;j\27\bc\ce\b6\a4-b\a3\a8\d0*o\0dse2\15w\1d\e2C\a6:\c0H\a1\8bY\da)'
DUMMY_CREDENTIAL_ID_BLOB='\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00\00'

SEED_PHRASE_PUB_KEY_BLOB='0*0\05\06\03+ep\03!\00;j\27\bc\ce\b6\a4-b\a3\a8\d0*o\0dse2\15w\1d\e2C\a6:\c0H\a1\8bY\db)'

add_device() {
  DEVICE_PUB_KEY_BLOB="$1"
  DEVICE_KEY_TYPE="$2"
  DEVICE_PURPOSE="$3"
  set dfx canister call internet_identity add "(${ANCHOR}, record { alias = \"\"; origin = opt \"http://${II_CANISTER_ID}.localhost:8080\"; protection = variant { unprotected }; pubkey = blob \"${DEVICE_PUB_KEY_BLOB}\"; key_type = variant { ${DEVICE_KEY_TYPE} }; purpose = variant { ${DEVICE_PURPOSE} }; credential_id = opt blob \"${DUMMY_CREDENTIAL_ID_BLOB}\"; })" --candid "$II_DID_FILE" --network "$DFX_NETWORK"
  "$@" > /dev/null
}

echo "Adding backup device for anchor $ANCHOR."
add_device "$DUMMY_PUB_KEY_BLOB" unknown authentication
echo "Adding seed phrase for anchor $ANCHOR."
add_device "$SEED_PHRASE_PUB_KEY_BLOB" seed_phrase recovery
