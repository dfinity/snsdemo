#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH"
. "$SOURCE_DIR/versions.bash"

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define long=wasm_dir desc="Where to store the imported wasm files" variable=WASM_DIR default="wasms"        # Matches `dfx nns import`
clap.define short=c long=ic_commit desc="The IC commit of the wasms" variable=DFX_IC_COMMIT default="$(
  . "$SOURCE_DIR/versions.bash"
  echo "$DFX_IC_COMMIT"
)"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

# Install ICP index locally as documented in:
# https://internetcomputer.org/docs/current/developer-docs/integrations/ledger/icp-index-local-setup

curl -o "$WASM_DIR"/icp_index.wasm.gz "https://download.dfinity.systems/ic/$DFX_IC_COMMIT/canisters/ic-icp-index-canister.wasm.gz"
gunzip "$WASM_DIR"/icp_index.wasm.gz

LEDGER_ACCOUNT_ID=$(dfx canister id nns-ledger)

dfx deploy icp_index --argument '(record {ledger_id = principal"'${LEDGER_ACCOUNT_ID}'";})'

ICP_INDEX_CANISTER=$(dfx canister id icp_index)

dfx canister call $ICP_INDEX_CANISTER ledger_id '()'

dfx canister call $ICP_INDEX_CANISTER status '()'