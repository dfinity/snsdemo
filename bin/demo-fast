#!/usr/bin/env bash
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH:$(dfx cache show)"

# Source the optparse.bash file ---------------------------------------------------
source "$SOURCE_DIR/optparse.bash"
# Define options
optparse.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
optparse.define short=c long=ic_commit desc="The IC commit to use" variable=IC_COMMIT default=""
optparse.define short=x long=ic_dir desc="Directory containing the ic source code" variable=IC_REPO_DIR default="$HOME/dfn/ic"
# Source the output file ----------------------------------------------------------
source "$(optparse.build)"
set -euxo pipefail
cd "$(dirname "$(realpath "$0")")/.."

demo-cleanup

# If ic-commit is specified, get execuables from there:
[[ "${IC_COMMIT:-}" == "" ]] || {
	DEMO_BIN="$(realpath "${SOURCE_DIR}/../bin-other")"
	rm -fr "$DEMO_BIN"
	export PATH="$DEMO_BIN:$PATH"
	(
		cd "$IC_REPO_DIR"
		git checkout "$IC_COMMIT"
		bazel build //rs/sns/cli:all
		cp bazel-bin/rs/sns/cli/sns "$DEMO_BIN"
		bazel build //rs/registry/admin:all
		cp bazel-bin/rs/registry/admin/ic-admin "$DEMO_BIN"
	)
	echo "Using binaries from ic commit: $IC_COMMIT"
}

export DFX_NETWORK
dfx-network-deploy --network "$DFX_NETWORK"

# dfx nns import --network-mapping "$DFX_NETWORK=mainnet"
# The above does NOT include nns-sns-wasm.  So import for local (which does include the canister????) and then copy to the requested network.
# dfx nns import
# jq '.*(.canisters | to_entries | map(select(.key | startswith("nns-")) | .value.remote.id[env.DFX_NETWORK] = .value.remote.id.local) |from_entries | {canisters:.})' dfx.json | sponge dfx.json
dfx nns import --network-mapping "$DFX_NETWORK=local"
dfx sns import

rm -fr "$HOME/.config/dfx/identity/snsdemo8"
dfx identity new --disable-encryption snsdemo8
dfx identity use snsdemo8

bin/dfx-ledger-get-icp --icp 900000000 --network "$DFX_NETWORK"
bin/dfx-neuron-create --icp 500000000 --network "$DFX_NETWORK"
bin/dfx-neuron-prolong --network "$DFX_NETWORK"

./bin/dfx-sns-whitelist-me --network "$DFX_NETWORK"
./bin/dfx-sns-subnet-add --network "$DFX_NETWORK"
./bin/dfx-sns-wasm-download
./bin/dfx-sns-wasm-upload --network "$DFX_NETWORK"

./bin/dfx-sns-config-random --network "$DFX_NETWORK"
dfx ledger top-up --amount 1.0 --network "$DFX_NETWORK" "$(dfx identity get-wallet --network "$DFX_NETWORK")"
./bin/dfx-sns-deploy --network "$DFX_NETWORK"

dfx canister id sns_root --network "$DFX_NETWORK"
dfx canister id sns_governance --network "$DFX_NETWORK"
dfx canister id sns_ledger --network "$DFX_NETWORK"
dfx canister id sns_swap --network "$DFX_NETWORK"

: hand over control of the dapp.  Skipped...

dfx-sns-sale-propose --network "$DFX_NETWORK"


: "Demo finished!  Hope you enjoyed the show."
