#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH"

print_help() {
  cat <<-EOF

	Import NNS canister definitions, including:
	- Entries in dfx.json
	- Candid files

	Polyfill for dfx nns import.  Upstream provides most of the data
	correctly now but still lacks controls for the II did file.
	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
clap.define short=c long=ic_commit desc="The git ref of the core NNS canisters" variable=DFX_IC_COMMIT default="$(
      . "$SOURCE_DIR/versions.bash"
      echo "$DFX_IC_COMMIT"
    )"
clap.define short=c long=ii_commit desc="The git ref of the internet_identity canister" variable=INTERNET_IDENTITY_RELEASE default="$(
      . "$SOURCE_DIR/versions.bash"
      echo "$INTERNET_IDENTITY_RELEASE"
    )"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

# Populates dfx.json and gets the did files
DFX_IC_COMMIT="$DFX_IC_COMMIT" dfx nns import --network-mapping "$DFX_NETWORK=mainnet"
# Update the II candid
curl -sSL --fail --retry 5 "https://raw.githubusercontent.com/dfinity/internet-identity/${INTERNET_IDENTITY_RELEASE}/src/internet_identity/internet_identity.did" -o "$(jq -r .canisters.internet_identity.candid dfx.json)"
