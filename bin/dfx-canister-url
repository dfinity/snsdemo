#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH"
. "$SOURCE_DIR/versions.bash"

print_help() {
  cat <<-EOF

	Prints the URL for a canister frontend.
	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
URL_TYPES=(static api)
# Define options
clap.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
clap.define short=c long=canister desc="The canister name" variable=DFX_CANISTER
clap.define short=t long=type desc="The canister type (options: ${URL_TYPES[@]})" variable=DFX_URL_TYPE default=static
clap.define short=o long=open desc="Open the URL in a browser" variable=DFX_OPEN nargs=0
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

# Historically, the canister name was given as a positional argument.
test -n "${DFX_CANISTER:-}" || (($# != 1)) || DFX_CANISTER="${1:-}"
test -n "${DFX_CANISTER:-}" || {
  echo "ERROR: Please specify a canister name or ID"
  exit 1
}

# Sanity check the URL type
printf '%s\0' "${URL_TYPES[@]}" | grep -Fxqz -- "$DFX_URL_TYPE" || {
  echo "ERROR: Unsupported URL type: '$DFX_URL_TYPE'"
  echo "       Valid options:"
  printf "       * %s\n" "${URL_TYPES[@]}"
  exit 1
} >&2
PREFERRED_HOST="HOST_${DFX_URL_TYPE^^}"

export DFX_NETWORK
export DFX_CANISTER
export CANISTER_ID

while ! test -e dfx.json; do
  cd .. || {
    echo "ERROR: dfx.json not found"
    exit 1
  }
done

# Some canisters have custom URLs, such as identity.ic0.app.
# There is no standard for this.  There should be.  So we will start one:
# For nns-dapp, dfx.json should include:
# { "canisters": {
#      "nns-dapp": {
#        "url": {
#          "ic": "https://nns.ic0.app",
#          "mainnet": "https://nns.ic0.app"
# } }  } }
url="$(c="$DFX_CANISTER" n="$DFX_NETWORK" jq -r '.canisters[env.DFX_CANISTER].url[env.DFX_NETWORK] // ""' dfx.json)"

# Not found?
# Each network also has a pattern for canister URLs of the form: https://CANISTER_ID.NETWORK_URL
test -n "${url:-}" || CANISTER_ID="$(dfx canister id --network "$DFX_NETWORK" "$DFX_CANISTER")"

# .. Maybe this is in production.  Prioritize this so that production builds are not easily affected by local configuration.
test -n "$url" || {
  if [[ "$DFX_NETWORK" == "ic" ]]; then
    case "$DFX_URL_TYPE" in
    static) url="https://${CANISTER_ID}.icp0.io" ;;
    api) HOST="https://icp-api.io" ;; # Note: The canister ID is NOT provided as a subdomain and no web assets are served.
    esac
  fi
}

# ... The network URL may be in the local dfx.json or in the common config.
GLOBAL_NETWORK_CONFIG_FILE="$HOME/.config/dfx/networks.json"
network_config() {
  ! test -e dfx.json || jq '.networks // {}' dfx.json
  ! test -e "$GLOBAL_NETWORK_CONFIG_FILE" || cat "$GLOBAL_NETWORK_CONFIG_FILE"
}
case "${DFX_URL_TYPE:-}" in
static)
  test -n "${url:-}" || url="$(network_config | jq -re '.[env.DFX_NETWORK].config | .STATIC_HOST // .HOST | first // ""')"
  ;;
api)
  test -n "${url:-}" || url="$(network_config | jq -re '.[env.DFX_NETWORK].config | .API_HOST // .HOST | first // ""')"
  ;;
*)
  {
    echo "ERROR: Unsupported url type: '$DFX_URL_TYPE'"
    exit 1
  } >&2
  ;;
esac

# Last try:  Assume the network is a testnet.
test -n "$url" || url="https://${CANISTER_ID}.${DFX_NETWORK}.testnet.dfinity.network"

if [[ "${DFX_OPEN:-}" == "true" ]]; then
  command=xdg-open                                  # Uses Linux default browser
  command -v "$command" &>/dev/null || command=open # Uses mac default browser
  command -v "$command" &>/dev/null || command=firefox
  command -v "$command" &>/dev/null || command=google-chrome
  command -v "$command" &>/dev/null || {
    printf "ERROR: %s\n" "Unable to detect how to open your browser."
    exit 1
  } >&2
else
  command="echo"
fi

"$command" "$url"
