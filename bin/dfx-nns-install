#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

print_help() {
  cat <<-EOF

	Wrapper script that calls 'dfx nns install' in a consistent and correct way
	by:
	* TODO: Downloading lifeline.wasm in advance to work around a bug where dfx
	        uses the wrong URL for it.
	* TODO: Clearing the wasms cache to avoid surprises in the canister versions
	        that get installed.

	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=c long=ic_commit desc="The IC commit of the wasms" variable=DFX_IC_COMMIT default="$(
  . "$SOURCE_DIR/versions.bash"
  echo "$DFX_IC_COMMIT"
)"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

WASMS_DIR="$(dfx cache show)/wasms"
mkdir -p $WASMS_DIR

if [ "$(ls -A "$WASMS_DIR")" ]; then
  # 'dfx nns install' will use wasms present in $WASMS_DIR, even if they do not
  # match the requested DFX_IC_COMMIT. So we move anything in $WASMS_DIR out of
  # the way to guarantee a predictable experience.
  DFX_CACHE_WASMS_BACKUP_DIR="$HOME/dfx-cache-wasms-backup-$(date +"%Y%m%d_%H%M%S")"
  mkdir -p "$DFX_CACHE_WASMS_BACKUP_DIR"
  echo "Moving wasms from ${WASMS_DIR} to ${DFX_CACHE_WASMS_BACKUP_DIR}"
  mv "$WASMS_DIR"/* "$DFX_CACHE_WASMS_BACKUP_DIR"

  restore_backup() {
    echo "Moving wasms from ${DFX_CACHE_WASMS_BACKUP_DIR} back to ${WASMS_DIR}"
    mv "$DFX_CACHE_WASMS_BACKUP_DIR"/* "$WASMS_DIR"
    rmdir "$DFX_CACHE_WASMS_BACKUP_DIR"
  }

  trap restore_backup EXIT
fi

# The URL of the lifeline.wasm changed at some point. If the new URL exists for
# the given commit, download it to prepopulate the wasms cache with the old
# filename. This prevents 'dfx nns install' from trying to download it at the
# old URL and failing.
# If the new URL doesn't exist, we assume that dfx will succeed in installing it
# on its own.
NEW_LIFELINE_WASM_URL="https://download.dfinity.systems/ic/${DFX_IC_COMMIT}/canisters/lifeline_canister.wasm.gz"
OLD_LIFELINE_FILE="${WASMS_DIR}/lifeline.wasm"

# '--fail' to prevent writing an output file on failure and '|| true' to ignore
# the error.
curl --fail --location "$NEW_LIFELINE_WASM_URL" -o "$OLD_LIFELINE_FILE" || true

export DFX_IC_COMMIT
dfx nns install
