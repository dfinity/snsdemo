#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

NNS_URL="$(dfx-network-provider --network "$DFX_NETWORK")"



: TODO: Get wasm


WASM_FILE=internet_identity_dev.wasm
test -e "$WASM_FILE" || DFX_NETWORK="$DFX_NETWORK" ./scripts/docker-build
SHA="$(sha256sum "$WASM_FILE" | awk '{print $1}')"
CANISTER_ID="rdmx6-jaaaa-aaaaa-aaadq-cai" # Production II
PROPOSER_NEURON="$(dfx-neuron-id --network "$DFX_NETWORK")"
MODE=reinstall
NNS_URL="$(dfx-network-provider --network "$DFX_NETWORK")"
PEM="$(dfx-identity-pem --identity snsdemo8)"

proposal_file="$(mktemp --suffix=.md propose-to-install-ii-XXXXXXXX)"
cat <<EOF >"$proposal_file"

Upgrade internet_identity at canister $CANISTER_ID to wasm with hash $SHA

EOF

ARG_FILE="$(mktemp internet_identity_arg_XXXX --suffix=bin)"
echo '()' | didc encode | xxd -r -p > "$ARG_FILE"


set ic-admin --nns-url "$NNS_URL" --secret-key-pem "$PEM" propose-to-change-nns-canister --proposer "$PROPOSER_NEURON" --canister-id "$CANISTER_ID" --mode "$MODE" --wasm-module-path "$WASM_FILE" --wasm-module-sha256 "$SHA" --summary-file "$proposal_file" --arg "$ARG_FILE"
echo "${@}"
"${@}"

rm "$proposal_file"
