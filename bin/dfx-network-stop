#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=n long=network desc="The dfx network to use" variable=DFX_NETWORK default="local"
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

export DFX_NETWORK

if [[ "$DFX_NETWORK" == "local" ]]; then
  : "Ask for a clean shutdown"
  dfx stop || true
  : "Also send the equivalent of ctrl-c, which _should_ be equivalent, as dfx stop often fails"
  ps af | grep -E '\<dfx\>.*\<s[t]art\>' | awk '{print $1}' | xargs --no-run-if-empty kill

  echo "Waiting for replica to stop..."
  for ((i = 100; i > 0; i--)); do
    printf '\r % 4d    ' "$i"
    pgrep replica || break
    sleep 1
  done

  : "Make sure that it is dead."
  sleep 1
  pkill -9 dfx || true
  pkill -9 replica || true
  pkill -9 icx-proxy || true
  sleep 1
else
  echo "Not stopping remote network: $DFX_NETWORK"
fi
