#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH"

help_text() {
  cat <<-EOF

	Restores a local dfx server state and releted identities from a saved ZIP file.

	Warning: This is recommended only for CI, as there is limited protection against
	local identities being clobbered by those in the zip file.

	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=s long=snapshot desc="The snapshot file to load." variable=DFX_SNAPSHOT_FILE default="state.tar.xz"
clap.define short=l long=logfile desc="A file to save logs." variable=DFX_LOG_FILE default=""
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

DFX_SNAPSHOT_FILE="$(realpath "$DFX_SNAPSHOT_FILE")"
dfx_start() {
  dfx start --background
}
test -z "${DFX_LOG_FILE:-}" || DFX_LOG_FILE="$(realpath "$DFX_LOG_FILE")"

pushd "$HOME"
rm -fr .local/share/dfx
tar --extract --xz --file "$DFX_SNAPSHOT_FILE"
# Note: dfx start works here but not in the project dir.
# Note: dfx has a --logfile agument, however when run with --background, no data apart from a few headers is collected.
if test -z "${DFX_LOG_FILE:-}"; then
  dfx_start
else
  echo "Saving logs to:  $DFX_LOG_FILE"
  dfx_start &>"${DFX_LOG_FILE}"
fi
num_canisters="$(curl -s "http://localhost:$(dfx info replica-port)/_/dashboard" | grep -c '<h3>Execution state</h3>')"
echo "Approx num canisters: $num_canisters"
popd
rm -fr .dfx
mv "$HOME/.dfx" .
dfx-sns-demo-healthcheck
