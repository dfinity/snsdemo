#!/usr/bin/env bash
set -euo pipefail
SOURCE_DIR="$(dirname "$(realpath "${BASH_SOURCE[0]}")")"
PATH="$SOURCE_DIR:$PATH"

print_help() {
  cat <<-EOF

	Creates a snapshot of a stock environment, for use in CI tests.
	EOF
}

# Source the clap.bash file ---------------------------------------------------
source "$SOURCE_DIR/clap.bash"
# Define options
clap.define short=s long=snapshot desc="The file to save to" variable=DFX_SNAPSHOT_FILE default="stock-snsdemo-snapshot.tar.xz"
clap.define short=g long=global desc="Store in the global cache" variable=DFX_GLOBAL_CACHE nargs=0
# Source the output file ----------------------------------------------------------
source "$(clap.build)"

[[ "${DFX_GLOBAL_CACHE:-}" != "true" ]] || {
  DFX_SNAPSHOT_FILE="$(dfx cache show)/snapshots/$(basename "$DFX_SNAPSHOT_FILE")"
  mkdir -p "$(dirname "$DFX_SNAPSHOT_FILE")"
}

echo "Restoring state..."
dfx-snapshot-restore --snapshot "$DFX_SNAPSHOT_FILE"
