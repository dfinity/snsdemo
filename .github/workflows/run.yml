name: Run non-interactive demo
on:
  push:
env:
  GH_TOKEN: ${{ github.token }}
jobs:
  #  readme:
  #    runs-on: ${{ matrix.os }}
  #    strategy:
  #      fail-fast: false
  #      matrix:
  #        os: [ macos-11, ubuntu-22.04 ]
  #    steps:
  #      - name: Checkout
  #        uses: actions/checkout@v3
  #      - name: Run the README code parts
  #        run: bin/test-readme
  demo_current:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, ubuntu-22.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Check tags
        run: |
          set -x
          echo HOME=$HOME
          echo PWD=$PWD
          pwd
          [[ "$PWD" == "$HOME" ]] ; echo $?
          pushd /
          popd
          git rev-parse HEAD
          git tag
          git tag --points-at HEAD
          echo Ref Name: ${{github.ref_name}}
      - name: Add user path
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$PWD/bin" >> $GITHUB_PATH
      - name: Unbork mac
        if: matrix.os == 'macos-11'
        run: |
          brew install bash
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "$(brew --prefix)/opt/gnu-sed/libexec/gnubin" >> $GITHUB_PATH
      - name: Install dependencies
        run: ./bin/dfx-sns-demo-install --verbose
      - name: Run the demo with the current default ic commits
        run: bin/dfx-sns-demo
      - name: Create and finalize an additional SNS
        run: |
          ./bin/dfx-sns-demo-mksns
          ./bin/dfx-sns-sale-buy
          ./bin/dfx-sns-sale-finalize
      - name: Create lots of SNS
        if: matrix.os != 'macos-11'
        run: |
          ./bin/dfx-sns-demo-mksns-parallel -s 10 -m snsdemo8
      - name: Save state
        if: matrix.os != 'macos-11'
        run: ./bin/dfx-state-save
      - name: Release
        if: matrix.os != 'macos-11'
        run: |
          artefacts=(state.zip)
          ls -l "${artefacts[@]}"
          for tag in $(git tag --points-at HEAD) ; do
            : Creates or updates a release for the tag
            if gh release view "$tag"
            then gh release upload --repo dfinity/nns-dapp --clobber "$tag" "${artefacts[@]}" || true
            else gh release create --title "Release for tags/$tag" --notes "Build artefacts from tag: $tag" "$tag" "${artefacts[@]}"
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  demo_latest:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [macos-11, ubuntu-22.04]
    steps:
      - name: Checkout
        uses: actions/checkout@v3
      - name: Add user path
        run: |
          echo "$HOME/.local/bin" >> $GITHUB_PATH
          echo "$PWD/bin" >> $GITHUB_PATH
      - name: Unbork mac
        if: matrix.os == 'macos-11'
        run: |
          brew install bash
          echo "/usr/local/bin" >> $GITHUB_PATH
          echo "$(brew --prefix)/opt/gnu-sed/libexec/gnubin" >> $GITHUB_PATH
      - name: Install dependencies
        run: ./bin/dfx-sns-demo-install --verbose
      # Clone the ic repo so that we can find the latest published commit. 
      - name: Checkout ic repo
        uses: actions/checkout@v3
        with:
          repository: dfinity/ic
          ref: master
          fetch-depth: 100
          path: ic
      - name: Run the demo with the latest repo
        run: bin/dfx-sns-demo --ic_commit latest --ic_dir ic
      - name: Create and finalize an additional SNS
        run: |
          ./bin/dfx-sns-demo-mksns
          ./bin/dfx-sns-sale-buy
          ./bin/dfx-sns-sale-finalize
      - name: Create lots of SNS
        if: matrix.os != 'macos-11'
        run: |
          ./bin/dfx-sns-demo-mksns-parallel -s 10 -m snsdemo8
